@* @page
@model SmartKB.Pages.IndexModel
<link rel="stylesheet" href="~/css/style.css" />

<!-- Welcome screen toggle (pure CSS, no JS) -->
<input type="checkbox" id="welcomeToggle" class="welcome-toggle" />

<!-- Welcome Screen -->
<div class="welcome-screen">
    <div class="welcome-card">
        <h1 class="welcome-title">Welcome to Smart Knowledge Base</h1>
        <p class="welcome-subtitle">
            Upload documents or paste text to generate clean, AI-powered summaries in seconds.
        </p>
        <label for="welcomeToggle" class="btn welcome-continue-btn">
            <span class="btn-text">Continue</span>
        </label>
    </div>
</div>

<!-- Main App Content -->
<div class="main-content">
    <!-- Mode selection screen -->
    <section id="modeScreen" class="mode-screen">
        <div class="container mode-container">
            <h1>Select what you want to summarize</h1>
            <div class="mode-buttons">
                <button type="button" id="modeTextBtn" class="btn mode-btn">
                    <span class="btn-text">Summarize Text</span>
                </button>
                <button type="button" id="modeFileBtn" class="btn mode-btn">
                    <span class="btn-text">Summarize File</span>
                </button>
            </div>
        </div>
    </section>

    <!-- Input screens -->
    <div class="container" id="inputContainer">
        <button type="button" id="backToSelectionBtn" class="btn-back">Back to Selection</button>
        <h1 id="inputTitle">Upload Documents</h1>

        <!-- Document Upload Form -->
        <form id="uploadForm" class="upload-form" aria-hidden="true">
            <label class="upload-box" for="fileInput" id="uploadLabel" role="button" tabindex="0" aria-describedby="helperText errorMsg">
                <div class="upload-content">
                    <svg class="upload-icon" width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8L14 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        <path d="M14 2V8H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        <path d="M12 18V12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        <path d="M9 15L12 12L15 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                    <span id="uploadText"><strong>Click or drag a file here</strong></span>
                    <span class="upload-subtext">to upload your document</span>
                </div>
                <input type="file" id="fileInput" name="file" accept=".pdf,.docx,.txt,.xls,.xlsx" aria-label="Choose document to upload" />
            </label>

            <div class="helper-text" id="helperText">
                <span>Supported formats: PDF, Word (.docx), Text (.txt), Excel (.xls, .xlsx)</span>
            </div>
            <div class="error-msg" id="errorMsg"></div>
            <div class="file-info" id="fileInfo">
                <span class="file-name"></span>
            </div>
            <button id="uploadButton" type="submit" class="btn">
                <span class="btn-text">Upload & Summarize</span>
            </button>
        </form>

        <pre id="result" class="summary-output"></pre>

        <!-- Text Input Summarization Section -->
        <form id="textForm" class="upload-form text-form" aria-hidden="true">
            <div class="text-card">
                <label for="textInput" id="textLabel" class="text-label">
                    <span id="textUploadText"><strong>Paste or type the text you want summarized</strong></span>
                    <textarea id="textInput"
                              placeholder="Paste or type the content you want summarized. You can include multiple paragraphs, bullet points, or long-form text here."
                              rows="10"
                              aria-label="Enter text to summarize"></textarea>
                </label>

                <div class="helper-text" id="textHelper">
                    <span>Paste any text you want to summarize. Longer inputs are supported.</span>
                </div>
                <div class="error-msg" id="textError"></div>
                <div class="file-info" id="textInfo" style="display:none;">
                    <span class="file-name">Text ready</span>
                </div>
                <button id="summarizeButton" type="submit" class="btn">
                    <span class="btn-text">Summarize Text</span>
                </button>
            </div>
        </form>

        <pre id="textResult" class="summary-output"></pre>
    </div>
</div>

<!-- Summary Modal -->
<div id="summaryModalOverlay" class="modal-overlay hidden" aria-hidden="true">
    <div class="modal">
        <div class="modal-header">
            <h2 class="modal-title">Summary</h2>
            <button type="button" id="modalCloseBtn" class="modal-close" aria-label="Close summary">
                ✕
            </button>
        </div>
        <div id="modalBody" class="modal-body">
        </div>
        <div class="modal-footer">
            <button type="button" id="downloadSummaryBtn" class="btn modal-download-btn">
                <span class="btn-text">Download Summary</span>
            </button>
        </div>
    </div>
</div>

<script>
    const allowedExtensions = [".pdf", ".docx", ".txt", ".xls", ".xlsx"];
    const uploadBox = document.querySelector(".upload-box");
    const fileInput = document.getElementById("fileInput");
    const fileInfo = document.getElementById("fileInfo");
    const errorMsg = document.getElementById("errorMsg");
    const result = document.getElementById("result");
    const uploadButton = document.getElementById("uploadButton");
    const modeScreen = document.getElementById("modeScreen");
    const inputContainer = document.getElementById("inputContainer");
    const inputTitle = document.getElementById("inputTitle");
    const uploadForm = document.getElementById("uploadForm");
    const textForm = document.getElementById("textForm");

    const modeTextBtn = document.getElementById("modeTextBtn");
    const modeFileBtn = document.getElementById("modeFileBtn");
    const backToSelectionBtn = document.getElementById("backToSelectionBtn");

    const modalOverlay = document.getElementById("summaryModalOverlay");
    const modalBody = document.getElementById("modalBody");
    const modalCloseBtn = document.getElementById("modalCloseBtn");
    const downloadSummaryBtn = document.getElementById("downloadSummaryBtn");

    let currentSummaryText = "";

    function disableUploadUI(disabled) {
        fileInput.disabled = disabled;
        uploadButton.disabled = disabled;
        if (disabled) {
            uploadButton.style.opacity = "0.6";
            uploadButton.style.cursor = "not-allowed";
            uploadBox.style.pointerEvents = "none";
            uploadBox.style.opacity = "0.6";
        } else {
            uploadButton.style.opacity = "1";
            uploadButton.style.cursor = "pointer";
            uploadBox.style.pointerEvents = "auto";
            uploadBox.style.opacity = "1";
        }
    }

    function setAllButtonsDisabled(disabled) {
        const buttons = document.querySelectorAll("button");
        buttons.forEach(btn => {
            btn.disabled = disabled;
        });
    }

    // Mode selection
    function resetInputScreens() {
        uploadForm.style.display = "none";
        uploadForm.setAttribute("aria-hidden", "true");
        textForm.style.display = "none";
        textForm.setAttribute("aria-hidden", "true");
    }

    function showFileMode() {
        modeScreen.style.display = "none";
        inputContainer.style.display = "block";
        inputTitle.textContent = "Upload Documents";
        resetInputScreens();
        uploadForm.style.display = "block";
        uploadForm.setAttribute("aria-hidden", "false");
    }

    function showTextMode() {
        modeScreen.style.display = "none";
        inputContainer.style.display = "block";
        inputTitle.textContent = "Summarize Text";
        resetInputScreens();
        textForm.style.display = "block";
        textForm.setAttribute("aria-hidden", "false");
    }

    function goBackToSelection() {
        inputContainer.style.display = "none";
        modeScreen.style.display = "block";
        resetInputScreens();
    }

    modeFileBtn.addEventListener("click", showFileMode);
    modeTextBtn.addEventListener("click", showTextMode);
    backToSelectionBtn.addEventListener("click", goBackToSelection);

    // Hide input container and forms by default
    inputContainer.style.display = "none";
    uploadForm.style.display = "none";
    textForm.style.display = "none";

    function buildSummaryHtml(summaryText) {
        if (!summaryText) return "";
        const parts = summaryText
            .split(/\n{2,}/)
            .map(p => p.trim())
            .filter(p => p.length > 0);

        if (parts.length === 0) {
            return `<p>${summaryText}</p>`;
        }

        return parts
            .map(p => `<p>${p}</p>`)
            .join("");
    }

    // Summary modal helpers
    function openSummaryModalFromText(summaryText) {
        currentSummaryText = summaryText || "";
        const summaryHtml = buildSummaryHtml(summaryText);
        modalBody.innerHTML = summaryHtml;
        modalOverlay.classList.remove("hidden");
        modalOverlay.setAttribute("aria-hidden", "false");
    }

    function closeSummaryModal() {
        modalOverlay.classList.add("hidden");
        modalOverlay.setAttribute("aria-hidden", "true");
        modalBody.innerHTML = "";
        currentSummaryText = "";
    }

    function downloadSummary() {
        if (!currentSummaryText) return;

        const blob = new Blob([currentSummaryText], { type: "text/plain;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "smartkb-summary.txt";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    modalCloseBtn.addEventListener("click", closeSummaryModal);
    modalOverlay.addEventListener("click", (e) => {
        if (e.target === modalOverlay) {
            closeSummaryModal();
        }
    });
    downloadSummaryBtn.addEventListener("click", downloadSummary);

    function resetErrors() {
        errorMsg.style.display = "none";
        errorMsg.innerText = "";
    }

    function validateFile(file) {
        resetErrors();
        const ext = file.name.toLowerCase().slice(file.name.lastIndexOf("."));
        if (!allowedExtensions.includes(ext)) {
            errorMsg.innerText = "Unsupported file type.";
            errorMsg.style.display = "block";
            fileInput.value = "";
            fileInfo.style.display = "none";
            return false;
        }
        return true;
    }

    function showFileName(file) {
        const fileNameSpan = fileInfo.querySelector(".file-name");
        if (fileNameSpan) {
            fileNameSpan.textContent = file.name;
        } else {
            fileInfo.innerHTML = `<span class="file-name">${file.name}</span>`;
        }
        fileInfo.style.display = "flex";
    }

    uploadBox.addEventListener("dragover", e => {
        e.preventDefault();
        if (fileInput.disabled) return;
        uploadBox.style.background = "#dde7ff";
    });

    uploadBox.addEventListener("dragleave", () => {
        if (fileInput.disabled) return;
        uploadBox.style.background = "#f9fbff";
    });

    uploadBox.addEventListener("drop", e => {
        e.preventDefault();
        if (fileInput.disabled) return;
        uploadBox.style.background = "#f9fbff";

        const file = e.dataTransfer.files[0];
        if (!validateFile(file)) return;

        fileInput.files = e.dataTransfer.files;
        showFileName(file);
    });

    fileInput.addEventListener("change", () => {
        if (fileInput.disabled) return;
        if (fileInput.files.length === 0) return;
        const file = fileInput.files[0];
        if (!validateFile(file)) return;
        showFileName(file);
    });

    document.getElementById("uploadForm").addEventListener("submit", async e => {
        e.preventDefault();
        if (!fileInput.files.length) return;

        const file = fileInput.files[0];

        disableUploadUI(true);
        setAllButtonsDisabled(true);
        result.style.display = "none";
        resetErrors();

        uploadButton.innerText = "AI summarization in progress...";
        uploadButton.classList.add("pulse");

        const formData = new FormData();
        formData.append("file", file);

        try {
            const res = await fetch("/api/Documents/upload", {
                method: "POST",
                body: formData
            });

            if (!res.ok) throw new Error("Upload failed");

            const data = await res.json();
            openSummaryModalFromText(data.summary);

        } catch (err) {
            errorMsg.innerText = "Upload or summarization failed.";
            errorMsg.style.display = "block";
        } finally {
            disableUploadUI(false);
            setAllButtonsDisabled(false);
            uploadButton.innerText = "Upload & Summarize";
            uploadButton.classList.remove("pulse");
        }
    });

    // Text summarization logic
    const textInput = document.getElementById("textInput");
    const summarizeButton = document.getElementById("summarizeButton");
    const textResult = document.getElementById("textResult");
    const textError = document.getElementById("textError");
    const textInfo = document.getElementById("textInfo");

    document.getElementById("textForm").addEventListener("submit", async e => {
        e.preventDefault();
        const text = textInput.value.trim();
        textError.style.display = "none";
        textError.innerText = "";

        if (!text) {
            textError.innerText = "Please enter text to summarize.";
            textError.style.display = "block";
            return;
        }

        summarizeButton.disabled = true;
        summarizeButton.innerText = "Summarizing...";
        textResult.style.display = "none";
        textInfo.style.display = "flex";
        setAllButtonsDisabled(true);

        try {
            const res = await fetch("/api/Documents/add-text", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ text })
            });

            if (!res.ok) throw new Error("Summarization failed");

            const data = await res.json();
            openSummaryModalFromText(data.summary);

        } catch (err) {
            textError.innerText = "Summarization failed. Try again.";
            textError.style.display = "block";
        } finally {
            summarizeButton.disabled = false;
            summarizeButton.innerText = "Summarize Text";
            setAllButtonsDisabled(false);
        }
    });
</script> *@
