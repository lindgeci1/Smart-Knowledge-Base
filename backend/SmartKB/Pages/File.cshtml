@page "/file"
@model SmartKB.Pages.FileModel
<link rel="stylesheet" href="~/css/style.css" />

<div class="container" id="inputContainer">
    <div style="display:flex; justify-content: space-between; align-items: center; gap: 8px; flex-wrap: wrap;">
        <a href="/selection" class="btn-back">Back to Selection</a>
        <button type="button" class="btn nav-btn" id="logoutBtn" style="width:auto; margin-top:0;">Logout</button>
    </div>
    <h1 id="inputTitle">Upload Documents</h1>

    <!-- Document Upload Form -->
    <form id="uploadForm" class="upload-form" aria-hidden="true">
        <label class="upload-box" for="fileInput" id="uploadLabel" role="button" tabindex="0" aria-describedby="helperText errorMsg">
            <div class="upload-content">
                <svg class="upload-icon" width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8L14 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M14 2V8H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M12 18V12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M9 15L12 12L15 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                <span id="uploadText"><strong>Click or drag a file here</strong></span>
                <span class="upload-subtext">to upload your document</span>
            </div>
            <input type="file" id="fileInput" name="file" accept=".pdf,.docx,.txt,.xls,.xlsx" aria-label="Choose document to upload" />
        </label>

        <div class="helper-text" id="helperText">
            <span>Supported formats: PDF, Word (.docx), Text (.txt), Excel (.xls, .xlsx)</span>
        </div>
        <div class="error-msg" id="errorMsg"></div>
        <div class="file-info" id="fileInfo">
            <span class="file-name"></span>
        </div>
        <button id="uploadButton" type="submit" class="btn">
            <span class="btn-text">Upload & Summarize</span>
        </button>
    </form>

    <pre id="result" class="summary-output"></pre>
    <pre id="textResult" class="summary-output"></pre>
</div>

<!-- Summary Modal -->
<div id="summaryModalOverlay" class="modal-overlay hidden" aria-hidden="true">
    <div class="modal">
        <div class="modal-header">
            <h2 class="modal-title">Summary</h2>
            <button type="button" id="modalCloseBtn" class="modal-close" aria-label="Close summary">
                ✕
            </button>
        </div>
        <div id="modalBody" class="modal-body">
        </div>
        <div class="modal-footer">
            <button type="button" id="downloadSummaryBtn" class="btn modal-download-btn">
                <span class="btn-text">Download Summary</span>
            </button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script type="module">
    import { apiClient, getJwtFromCookie } from "/js/auth.js";

    console.log("File.cshtml script loaded");

    document.addEventListener("DOMContentLoaded", async () => {
        let token = getJwtFromCookie();
        
        // If no JWT but refresh token might exist, try to renew silently
        // Don't call logout here - let interceptor handle it when API calls are made
        if (!token) {
            try {
                const renewRes = await axios.post(
                    "http://localhost:5074/api/auth/renew",
                    {},
                    { withCredentials: true }
                );
                const newJwt = renewRes.data?.jwt || renewRes.data?.Jwt;
                if (newJwt) {
                    token = newJwt;
                    document.cookie = `token=${newJwt}; path=/; max-age=900;`;
                } else {
                    // No JWT returned - redirect to login
                    // Don't call logout - refresh token might still be valid for next API call
                    window.location.replace("/login");
                    return;
                }
            } catch {
                // Renew failed - redirect to login
                // Don't call logout here - interceptor will handle logout when API calls fail
                window.location.replace("/login");
                return;
            }
        }

        const backButton = document.querySelector(".btn-back");
        const logoutButton = document.getElementById("logoutBtn");
        const uploadBox = document.getElementById("uploadLabel");
        const allowedExtensions = [".pdf", ".docx", ".txt", ".xls", ".xlsx"];
        const fileInput = document.getElementById("fileInput");
        const uploadButton = document.getElementById("uploadButton");
        const fileInfo = document.getElementById("fileInfo");
        const errorMsg = document.getElementById("errorMsg");
        const modalOverlay = document.getElementById("summaryModalOverlay");
        const modalBody = document.getElementById("modalBody");
        const modalCloseBtn = document.getElementById("modalCloseBtn");
        const downloadSummaryBtn = document.getElementById("downloadSummaryBtn");

        let currentSummaryText = "";
        let uploading = false;

        function showFileName(file) {
            fileInfo.querySelector(".file-name").textContent = file.name;
            fileInfo.style.display = "flex";
        }

        function validateFile(file) {
            const ext = file.name.toLowerCase().slice(file.name.lastIndexOf("."));
            if (!allowedExtensions.includes(ext)) {
                errorMsg.innerText = "Unsupported file type.";
                errorMsg.style.display = "block";
                fileInput.value = "";
                fileInfo.style.display = "none";
                return false;
            }
            errorMsg.style.display = "none";
            return true;
        }

        fileInput.addEventListener("change", () => {
            if (!fileInput.files.length) return;
            const file = fileInput.files[0];
            if (!validateFile(file)) return;
            showFileName(file);
        });

        backButton.addEventListener("click", (e) => {
            if (uploading) e.preventDefault();
        });

        logoutButton.addEventListener("click", async () => {
            await import("/js/auth.js").then(mod => mod.logout());
        });

        uploadButton.addEventListener("click", async (e) => {
            e.preventDefault();
            if (!fileInput.files.length) return;

            uploading = true;

            uploadButton.disabled = true;
            fileInput.disabled = true;
            backButton.style.pointerEvents = "none";
            backButton.style.opacity = "0.5";
            uploadBox.style.pointerEvents = "none";
            uploadBox.style.opacity = "0.5";

            uploadButton.innerText = "AI summarization in progress...";

            const formData = new FormData();
            formData.append("file", fileInput.files[0]);

            try {
                const res = await apiClient.post("/Documents/upload", formData, {
                    headers: { "Content-Type": "multipart/form-data" }
                });
                const data = res.data;
                currentSummaryText = data.summary;
                modalBody.innerHTML = data.summary.split(/\n{2,}/).map(p => `<p>${p}</p>`).join("");
                modalOverlay.classList.remove("hidden");
                modalOverlay.setAttribute("aria-hidden", "false");
            } catch (err) {
                console.error(err);
                errorMsg.innerText = "Upload or summarization failed.";
                errorMsg.style.display = "block";
            } finally {
                uploading = false;

                uploadButton.disabled = false;
                fileInput.disabled = false;
                backButton.style.pointerEvents = "auto";
                backButton.style.opacity = "1";
                uploadBox.style.pointerEvents = "auto";
                uploadBox.style.opacity = "1";

                uploadButton.innerText = "Upload & Summarize";
            }
        });

        modalCloseBtn.addEventListener("click", () => {
            modalOverlay.classList.add("hidden");
            modalOverlay.setAttribute("aria-hidden", "true");
            modalBody.innerHTML = "";
            currentSummaryText = "";
        });

        downloadSummaryBtn.addEventListener("click", () => {
            if (!currentSummaryText) return;
            const blob = new Blob([currentSummaryText], { type: "text/plain;charset=utf-8" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "smartkb-summary.txt";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });
    });
</script>
